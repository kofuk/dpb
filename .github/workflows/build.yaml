name: Build Images
on:
  push:
    branches:
      - master


permissions:
  contents: read
  packages: write

jobs:
  target-apps:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.collect.outputs.apps }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Collect build targets
        id: collect
        run: |
          tmp=$(mktemp)

          for dir in */; do
            image_ref="ghcr.io/${GITHUB_REPOSITORY}/${dir%/}:$(./resolve-tag.sh "${dir}")"
            if ! docker manifest inspect "${image_ref}"; then
              echo "${dir%/}" >> "${tmp}"
            fi
          done

          echo "apps=$(cat "${tmp}" | jq --null-input --raw-input --indent 0 '[inputs]')" >>"${GITHUB_OUTPUT}"

  build:
    needs: target-apps
    # GitHub Actions doesn't allow empty matrix.
    if: ${{ needs.target-apps.outputs.apps != '[]' }}
    strategy:
      matrix:
        app: ${{ fromJson(needs.target-apps.outputs.apps) }}
    name: Build ${{ matrix.app }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
      - name: Extract tag
        id: tag
        run: |
          echo "tag=ghcr.io/${GITHUB_REPOSITORY}/${{ matrix.app }}:$(./resolve-tag.sh "${APP}")" >>"${GITHUB_OUTPUT}"
        env:
          APP: ${{ matrix.app }}
      - uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          tags: ${{ steps.tag.outputs.tag }}
          context: ${{ matrix.app }}
          push: true
